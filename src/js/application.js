Opal.modules["authentication/login_form"] = function(Opal) {/* Generated by Opal 1.8.2 */
  var $send = Opal.send, $eqeq = Opal.eqeq, $truthy = Opal.truthy, $def = Opal.def, $rb_plus = Opal.rb_plus, $not = Opal.not, self = Opal.top, $nesting = [], $$ = Opal.$r($nesting), nil = Opal.nil;

  Opal.add_stubs('box,touch,delete,input,border,text,puts,data,message,==,[],key?,setItem,global,where,db,data=,empty?,strip,nil?,+,encode,connect,!,valid_email_format?,is_a?,getItem,identity_generator,inspect,match?,db_access,sanitized_email,first');
  return $def(self, '$authent_form', function $$authent_form() {
    var self = this, dark_grey_transparent = nil, grey = nil, eastern_blue = nil, view = nil, form = nil, cancel = nil, email_box = nil, email_error_message = nil, password_box = nil, password_error_message = nil, connection = nil, creation = nil;

    
    dark_grey_transparent = (new Map([["red", 0.125], ["green", 0.125], ["blue", 0.125], ["alpha", 0.7]]));
    grey = (new Map([["red", 0.208], ["green", 0.208], ["blue", 0.208]]));
    eastern_blue = (new Map([["red", 0.118], ["green", 0.596], ["blue", 0.596]]));
    view = self.$box((new Map([["id", "poipoi"], ["left", 0], ["right", 0], ["top", 0], ["bottom", 0], ["height", "auto"], ["width", "auto"], ["color", dark_grey_transparent]])));
    form = view.$box((new Map([["width", 500], ["height", 350], ["center", true], ["color", grey], ["smooth", 10]])));
    cancel = form.$box((new Map([["width", 25], ["height", 25], ["top", 25], ["left", 450]])));
    $send(cancel, 'touch', [true], function $$1(){
      return view.$delete(true)});
    email_box = form.$input((new Map([["width", 400], ["height", 50], ["top", 50], ["left", 10], ["color", grey], ["smooth", 0], ["text", "white"], ["default", "Email"]])));
    email_box.$border((new Map([["thickness", 2], ["red", 0.1], ["green", 0.8], ["blue", 0.8], ["alpha", 1], ["pattern", "solid"]])));
    email_error_message = form.$text((new Map([["data", ""], ["left", 20], ["top", 115], ["color", "red"]])));
    self.$puts("input email error text : " + (email_error_message.$data()));
    password_box = form.$input((new Map([["width", 400], ["height", 50], ["top", 150], ["left", 10], ["position", "absolute"], ["color", grey], ["smooth", 0], ["text", "white"], ["default", "Password"]])));
    password_box.$border((new Map([["thickness", 2], ["red", 0.1], ["green", 0.8], ["blue", 0.8], ["alpha", 1], ["pattern", "solid"]])));
    password_error_message = form.$text((new Map([["data", ""], ["left", 10], ["top", 210], ["color", "red"]])));
    self.$puts("input password error text : " + (password_error_message.$data()));
    connection = form.$box((new Map([["width", 100], ["height", 50], ["left", 50], ["top", 250], ["color", "white"], ["smooth", 5], ["border", (new Map([["thickness", 2], ["color", eastern_blue], ["pattern", "solid"]]))], ["text", (new Map([["int8", (new Map([["francais", "Se connecter"], ["english", "Login"]]))], ["color", "black"], ["center", (new Map([["x", 30], ["y", -1]]))]]))], ["id", "connection_btn"]])));
    
    $def(self, '$connect', function $$connect(mail, pass) {
      var self = this;

      
      $send($$('A'), 'message', [(new Map([["action", "authentication"], ["data", (new Map([["table", "user"], ["particles", (new Map([["email", mail]]))]]))]]))], function $$2(response){var self = $$2.$$s == null ? this : $$2.$$s, mail_message = nil, mail_response = nil, user_id = nil, user_items = nil;

        
        if (response == null) response = nil;
        if (($truthy(response['$key?']("mail_authorized")) && ($eqeq(response['$[]']("mail_authorized"), true)))) {
          
          self.$puts("response mail authorized: " + (response['$[]']("mail_authorized")));
          mail_message = $$('JS').$global()['$[]']("localStorage").$setItem("logged", response['$[]']("mail_authorized"));
          mail_response = response['$[]']("mail_authorized");
          self.$puts("mail_response : " + (mail_response));
          $$('JS').$global()['$[]']("localStorage").$setItem("current_user", response['$[]']("user_id"));
          self.$puts("Rcupration des items du user");
          user_id = response['$[]']("user_id");
          self.$puts("user_id: " + (user_id));
          user_items = self.$db()['$[]']("atome").$where((new Map([["creator", user_id]])));
          return self.$puts(" user_items: " + (user_items));
        } else {
          return nil
        };}, {$$s: self});
      return $send($$('A'), 'message', [(new Map([["action", "authorization"], ["data", (new Map([["table", "user"], ["particles", (new Map([["password", pass]]))]]))]]))], function $$3(response){var self = $$3.$$s == null ? this : $$3.$$s, authorized = nil, $ret_or_1 = nil, password_message = nil, password_response = nil, user_id = nil;

        
        if (response == null) response = nil;
        self.$puts("authorization : " + (response));
        if ($truthy(response['$key?']("password_authorized"))) {
          
          authorized = ($truthy(($ret_or_1 = response['$[]']("password_authorized"))) && ($ret_or_1));
          self.$puts("response password : " + (response['$[]']("password_authorized")));
          password_message = $$('JS').$global()['$[]']("localStorage").$setItem("logged", response['$[]']("password_authorized"));
          password_response = response['$[]']("password_authorized");
          self.$puts("password_response : " + (password_response));
          $$('JS').$global()['$[]']("localStorage").$setItem("current_user", response['$[]']("user_id"));
          self.$puts("Rcupration des items du user");
          user_id = response['$[]']("user_id");
          self.$puts("user_id: " + (user_id));
          return self.$puts("user_items : " + (response['$[]']("user_items")));
        } else {
          return nil
        };}, {$$s: self});
    });
    $send(connection, 'touch', [true], function $$4(){var self = $$4.$$s == null ? this : $$4.$$s, mail = nil, pass = nil, mail_message = nil, mail_response = nil, password_message = nil, password_response = nil;

      
      email_error_message['$data=']("");
      password_error_message['$data=']("");
      if ((($truthy(email_box.$data()['$nil?']()) || ($truthy(email_box.$data().$strip()['$empty?']()))) && (($truthy(password_box.$data()['$nil?']()) || ($truthy(password_box.$data().$strip()['$empty?']())))))) {
        
        email_error_message['$data=']("Veuillez renseigner votre adresse email");
        password_error_message['$data=']("Veuillez renseigner votre mot de passe");
        return self.$puts("Veuillez renseigner votre adresse email et votre mot de passe.");
      } else if (($truthy(email_box.$data()['$nil?']()) || ($truthy(email_box.$data().$strip()['$empty?']())))) {
        
        email_error_message['$data=']("Veuillez renseigner votre adresse email");
        return self.$puts("Veuillez renseigner votre adresse email.");
      } else if (($truthy(password_box.$data()['$nil?']()) || ($truthy(password_box.$data().$strip()['$empty?']())))) {
        
        password_error_message['$data=']("Veuillez renseigner votre mot de passe");
        return self.$puts("Veuillez renseigner votre mot de passe.");
      } else {
        
        mail = email_box.$data();
        self.$puts($rb_plus("mail : ", mail));
        pass = $$('Black_matter').$encode(password_box.$data());
        self.$puts($rb_plus("pass : ", pass));
        mail_message = false;
        mail_response = nil;
        password_message = false;
        password_response = nil;
        return self.$connect(mail, pass);
      };}, {$$s: self});
    creation = form.$box((new Map([["width", 110], ["height", 50], ["left", 340], ["top", 250], ["color", grey], ["smooth", 5], ["border", (new Map([["thickness", 2], ["color", eastern_blue], ["pattern", "solid"]]))], ["text", (new Map([["int8", (new Map([["francais", "Crer un compte"], ["english", "Create account"]]))], ["left", 10], ["color", "white"]]))], ["id", "creation_btn"]])));
    $send(creation, 'touch', [true], function $$5(){var self = $$5.$$s == null ? this : $$5.$$s, mail = nil;

      
      email_error_message['$data=']("");
      password_error_message['$data=']("");
      if ((($truthy(email_box.$data()['$nil?']()) || ($truthy(email_box.$data().$strip()['$empty?']()))) && (($truthy(password_box.$data()['$nil?']()) || ($truthy(password_box.$data().$strip()['$empty?']())))))) {
        
        email_error_message['$data=']("Veuillez renseigner votre adresse email");
        password_error_message['$data=']("Veuillez renseigner votre mot de passe");
        return self.$puts("Veuillez renseigner votre adresse email et votre mot de passe.");
      } else if (($truthy(email_box.$data()['$nil?']()) || ($truthy(email_box.$data().$strip()['$empty?']())))) {
        
        email_error_message['$data=']("Veuillez renseigner votre adresse email");
        return self.$puts("Veuillez renseigner votre adresse email.");
      } else if (($truthy(password_box.$data()['$nil?']()) || ($truthy(password_box.$data().$strip()['$empty?']())))) {
        
        password_error_message['$data=']("Veuillez renseigner votre mot de passe");
        return self.$puts("Veuillez renseigner votre mot de passe.");
      } else {
        
        mail = email_box.$data();
        self.$puts($rb_plus("mail : ", mail));
        if ($not(self['$valid_email_format?'](mail))) {
          
          email_error_message['$data=']("L'adresse email n'est pas valide");
          return self.$puts("L'adresse email n'est pas valide.");
        } else {
          return $send($$('A'), 'message', [(new Map([["action", "email_exist"], ["data", (new Map([["email", mail]]))]]))], function $$6(response){var self = $$6.$$s == null ? this : $$6.$$s, pass = nil, anon_id = nil, e = nil;

            
            if (response == null) response = nil;
            try {
              
              self.$puts("response['data']['email_exist'] : " + (response['$[]']("data")['$[]']("email_exist")));
              if ($truthy(response['$is_a?']($$('Hash')))) {
                
                self.$puts(" hi ");
                if ($eqeq(response['$[]']("data")['$[]']("email_exist"), true)) {
                  
                  email_error_message['$data=']("L' email est dj utilis.Veuillez en choisir un autre ");
                  return self.$puts(" L 'email existe dj. Veuillez en choisir un autre.");
                } else {
                  
                  pass = $$('Black_matter').$encode(password_box.$data());
                  self.$puts($rb_plus(" pass : ", pass));
                  anon_id = $$('JS').$global()['$[]']("localStorage").$getItem("anonymous_id");
                  $$('A').$message((new Map([["action", "insert"], ["data", (new Map([["table", "user"], ["particles", (new Map([["email", mail], ["password", pass], ["user_id", anon_id]]))]]))]])));
                  self.$connect(mail, pass);
                  return $$('JS').$global()['$[]']("localStorage").$setItem("anonymous_id", self.$identity_generator());
                };
              } else {
                return self.$puts("Rponse inattendue du serveur : " + (response.$inspect()))
              };
            } catch ($err) {
              if (Opal.rescue($err, [$$('StandardError')])) {(e = $err)
                try {
                  return self.$puts("Une erreur est survenue lors de la vrification de l'email : " + (e.$message()))
                } finally { Opal.pop_exception($err); }
              } else { throw $err; }
            };}, {$$s: self})
        };
      };}, {$$s: self});
    
    $def(self, '$valid_email_format?', function $valid_email_format$ques$7(email) {
      var email_pattern = nil;

      
      email_pattern = /^[\w+\-.]+@[a-z\d\-.]+\.[a-z]+$/i;
      return email_pattern['$match?'](email);
    });
    return $def(self, '$email_exist?', function $email_exist$ques$8(mail) {
      var self = this, db = nil, user_table = nil, sanitized_email = nil, user = nil;

      
      db = self.$db_access();
      user_table = db['$[]']("user");
      sanitized_email = self.$sanitized_email(mail);
      user = user_table.$where((new Map([["email", sanitized_email]]))).$first();
      return user['$nil?']()['$!']();
    });
  })
};

Opal.modules["templates/templat"] = function(Opal) {/* Generated by Opal 1.8.2 */
  var $eqeq = Opal.eqeq, $not = Opal.not, $rb_plus = Opal.rb_plus, $send = Opal.send, $neqeq = Opal.neqeq, self = Opal.top, $nesting = [], $$ = Opal.$r($nesting), nil = Opal.nil, anonymous_id = nil, current_user = nil, box1 = nil, box2 = nil, navigation_button = nil, logout_button = nil;

  Opal.add_stubs('getItem,[],global,puts,==,clear,!,current_user,setItem,box,center,text,+,creator,touch,color,circle,!=,message,top,left,width,height,authent_form');
  
  anonymous_id = $$('JS').$global()['$[]']("localStorage").$getItem("anonymous_id");
  self.$puts("anonymous_id : " + (anonymous_id));
  current_user = $$('JS').$global()['$[]']("localStorage").$getItem("current_user");
  self.$puts("current_user : " + (current_user));
  if ($eqeq(current_user, anonymous_id)) {
    
    $$('JS').$global()['$[]']("localStorage").$clear();
    self.$puts("local storage cleared!");
  };
  if ($not(anonymous_id)) {
    
    anonymous_id = $$('Universe').$current_user();
    self.$puts("new anonymous_id : " + (anonymous_id));
    $$('JS').$global()['$[]']("localStorage").$setItem("anonymous_id", anonymous_id);
  };
  if ($not(current_user)) {
    
    current_user = $$('Universe').$current_user();
    self.$puts("new current_user : " + (current_user));
    $$('JS').$global()['$[]']("localStorage").$setItem("current_user", current_user);
  };
  box1 = self.$box((new Map([["creator", current_user], ["width", 300], ["height", 100], ["color", "green"]])));
  box1.$text("Creer un atome").$center(true);
  self.$puts($rb_plus("createur : ", box1.$creator()));
  $send(box1, 'touch', [true], function $$1(){var self = $$1.$$s == null ? this : $$1.$$s, c = nil;

    
    box1.$color("red");
    current_user = $$('JS').$global()['$[]']("localStorage").$getItem("current_user");
    c = self.$circle((new Map([["creator", current_user], ["color", "green"], ["top", 200], ["left", 200], ["width", 250], ["height", 80]])));
    c.$text($rb_plus("creator : ", current_user));
    self.$puts($rb_plus("createur de c : ", c.$creator()));
    if ($neqeq(current_user, anonymous_id)) {
      return $$('A').$message((new Map([["action", "insert"], ["data", (new Map([["table", "atome"], ["particles", (new Map([["creator", c.$creator()], ["top", c.$top()], ["left", c.$left()], ["width", c.$width()], ["height", c.$height()]]))]]))]])))
    } else {
      return nil
    };}, {$$s: self});
  box2 = self.$box((new Map([["creator", current_user], ["width", 200], ["left", 350]])));
  $send(box2, 'touch', [true], function $$2(){var self = $$2.$$s == null ? this : $$2.$$s, b = nil;

    
    b = self.$box((new Map([["top", 200], ["left", 200]])));
    return $$('A').$message((new Map([["action", "insert"], ["data", (new Map([["table", "atome"], ["particles", (new Map([["creator", b.$creator()], ["top", b.$top()], ["left", b.$left()], ["width", b.$width()], ["height", b.$height()]]))]]))]])));}, {$$s: self});
  navigation_button = self.$box((new Map([["creator", current_user], ["width", 300], ["height", 100], ["top", 500], ["left", 50]])));
  navigation_button.$text("Aller au formulaire d'inscription").$center(true);
  $send(navigation_button, 'touch', [true], function $$3(){var self = $$3.$$s == null ? this : $$3.$$s;

    
    self.$require("templates/templat.rb"+ '/../' + "../authentication/login_form");
    return self.$authent_form();}, {$$s: self});
  logout_button = self.$box((new Map([["width", 150], ["height", 80], ["top", 50], ["left", 500], ["color", "red"]])));
  logout_button.$text((new Map([["text", "Log out"], ["color", "black"]])));
  return $send(logout_button, 'touch', [true], function $$4(){
    
    $$('JS').$global()['$[]']("localStorage").$setItem("logged", "false");
    return $$('JS').$global()['$[]']("localStorage").$setItem("current_user", anonymous_id);});
};

Opal.queue(function(Opal) {/* Generated by Opal 1.8.2 */
  var self = Opal.top, nil = Opal.nil;

  Opal.add_stubs('require');
  return self.$require("templates/templat")
});
